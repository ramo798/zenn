---
title: "remix ã§ hyperdrive(PostgreSQL) ã§ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã¾ã§ "
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Cloudflare","remix","postgresql","drizzle"]
published: true
---

## è¦ç´„

remix on Cloudflareã«ã¦ã€hyperdrive(PostgreSQL)ã‚’ä½¿ç”¨ã—ãŸãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã¾ã§ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«ãªã‚Šã¾ã™ã€‚

## remixãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ãƒ­ãƒ¼ã‚«ãƒ«ã«PostgreSQLã®æº–å‚™

### remixãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

å…¬å¼ã§ã‚³ãƒãƒ³ãƒ‰ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’ä½¿ç”¨ã—ã¦ä½œæˆã—ã¾ã™ã€‚

https://developers.cloudflare.com/workers/framework-guides/web-apps/react-router/


```
npm create cloudflare@latest -- my-react-router-app --framework=react-router
```

`npm run dev` ã«ã¦èµ·å‹•ã®ç¢ºèªãŒã§ãã‚Œã°å®Œäº†ã§ã™ã€‚

### PostgreSQLã®æº–å‚™

`docker-compose.yml` ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚


```yaml:docker-compose.yaml
version: '3'
services:
  postgres:
    container_name: sample-db
    image: postgres:16.1
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
```

`docker compose up` ã«ã¦èµ·å‹•ã—ã¦ãŠãã¾ã™ã€‚


## drizzleã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã„ã¾ã™ã€‚

```bash
npm i drizzle-orm postgres dotenv
npm i -D drizzle-kit tsx @types/node
```

### .envã®ä½œæˆ

```.env
DATABASE_URL='postgresql://postgres:postgres@localhost:5432/postgres'
```

### drizzleã®ã‚¹ã‚­ãƒ¼ãƒã¨configã®ä½œæˆ


```ts:/db/schema.ts
import { pgTable, serial, varchar, timestamp } from "drizzle-orm/pg-core";

export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  name: varchar("name", { length: 255 }).notNull(),
  email: varchar("email", { length: 255 }).notNull().unique(),
  createdAt: timestamp("created_at").defaultNow(),
});
```

```ts:/drizzle.config.ts
import type { Config } from "drizzle-kit"

export default {
  out: "./drizzle",
  schema: "./db/schema.ts",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
} satisfies Config
```

DBã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚ã®å€¤ã¯ã€ç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ¸¡ã›ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
`tsconfig.node.json` ã®ã€includeã« `drizzle.config.ts` è¿½åŠ ã™ã‚‹ã“ã¨ã§ç’°å¢ƒå¤‰æ•°ã‚’èª­ã‚ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚


## hyperdriveã®è¨­å®š

### wrangler.jsoncã®ä¿®æ­£

ä»Šå›ã®docker-composeã®è¨­å®šã«åˆã‚ã›ã¦ã€localConnectionStringã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

```json:wrangler.jsonc
{
  "compatibility_flags": [
    "nodejs_compat"
  ],
  "compatibility_date": "2024-09-23",
  "hyperdrive": [
    {
      "binding": "HYPERDRIVE",
      "id": "<your-hyperdrive-id-here>",
			"localConnectionString": "postgresql://postgres:postgres@localhost:5432/postgres"
    },
  ],
}
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€è¿½åŠ ã—ãŸhyperdriveé–¢é€£ã®å‹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```bash
npm run cf-typegen
```


### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç­‰

ã‚ã¨ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ãã¨ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¾ã§è¡Œã‚ã‚Œã¾ã™ã€‚

```bash
npx drizzle-kit generate
npx drizzle-kit migrate
```

### åˆæœŸãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥

å¥½ããªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã€åˆæœŸãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥ã‚’è¡Œãªã£ã¦ãã ã•ã„ã€‚

## DBã‚¢ã‚¯ã‚»ã‚¹ã®å‡¦ç†ã®ä½œæˆ


ã‚¤ãƒ³ãƒãƒ¼ãƒˆç³»ã®ã‚¨ãƒ©ãƒ¼ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€`tsconfig.cloudflare.json` ã®includeã«`"db/*"`ã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«home.tsxã«DBã¸ã®å•ã„åˆã‚ã›ã®å‡¦ç†ã‚’æ›¸ãã¾ã™ã€‚

```tsx:home.tsx
import type { Route } from "./+types/home";
import { Welcome } from "../welcome/welcome";
import postgres from "postgres";
import { drizzle } from "drizzle-orm/postgres-js";
import { users } from "db/schema";

export function meta({}: Route.MetaArgs) {
  return [
    { title: "New React Router App" },
    { name: "description", content: "Welcome to React Router!" },
  ];
}

export async function loader({ context }: Route.LoaderArgs) {
    const sql = postgres(context.cloudflare.env.HYPERDRIVE.connectionString, {
      max: 5,
      fetch_types: false,
    })
    const db = drizzle(sql)
    const allUsers = await db.select().from(users)
  console.log(allUsers)

  return { message: context.cloudflare.env.VALUE_FROM_CLOUDFLARE };
}

export default function Home({ loaderData }: Route.ComponentProps) {
  return <Welcome message={loaderData.message} />;
}
```




```
18:41:56 [vite] server restarted.
[
  {
    id: 1,
    name: 'asc',
    email: 'asc',
    createdAt: 2025-10-25T18:38:03.106Z
  },
  {
    id: 4,
    name: 'sc',
    email: 'ccc',
    createdAt: 2025-10-25T18:38:10.696Z
  },
  {
    id: 5,
    name: 'cc',
    email: 'sc',
    createdAt: 2025-10-25T18:38:10.700Z
  },
  {
    id: 6,
    name: 'ccc',
    email: 'bb',
    createdAt: 2025-10-25T18:38:10.702Z
  }
]
```

ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¾ã—ãŸãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚

## å‚è€ƒ


https://developers.cloudflare.com/hyperdrive/examples/connect-to-postgres/postgres-drivers-and-libraries/drizzle-orm/