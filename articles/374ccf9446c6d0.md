---
title: "sveltekit + supabase Authentication ã§ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã¨ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã§ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã™ã‚‹"
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

<!-- https://zenn.dev/keitakn/scraps/3fd37cb11321c2 -->

## åˆã‚ã«

sveltekit ã¨ supabase ã‚’çµ„ã¿åˆã‚ã›ã¦ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’ä½œã‚‹ã¨ãã«ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆãŒã„ãã¤ã‹ã‚ã£ãŸã®ã§ã€è§£æ±ºæ–¹æ³•ã‚’è¾¼ã¿ã§ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚
åŸºæœ¬çš„ã«ã¯å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

https://supabase.com/docs/guides/auth/auth-helpers/sveltekit

å‰ææ¡ä»¶
ãƒ»supabase ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯å–å¾—æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨
ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
node v16.18.0
"svelte": "^4.0.0",
"@sveltejs/kit": "^1.20.4",

## ä¸‹æº–å‚™

ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
npm install @supabase/auth-helpers-sveltekit @supabase/supabase-js
```

ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

```
PUBLIC_SUPABASE_URL=https://your-project.supabase.co
PUBLIC_SUPABASE_ANON_KEY=your-anon-key

```

supabase cli ã‚’ä½¿ç”¨ã—ã¦ã€ä½¿ç”¨ã™ã‚‹å‹æƒ…å ±ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```
supabase gen types typescript --project-id lhdpiaqrjeoxlxptkeot > database.types.ts
```

## ã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…

src/app.d.ts ã®è¨­å®š
ã“ã“ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒã§ã‚‹ã®ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚

```
declare namespace App {
	interface Locals {
		supabase?: SupabaseClient<Database>
		getSession(): Promise<Session | null>
	}
	interface PageData {
		session: Session | null
	}
	// interface Platform {}
	// interface Error {}
}

```

Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ
src/ hooks.server.ts

```
import { PUBLIC_SUPABASE_URL, PUBLIC_SUPABASE_ANON_KEY } from '$env/static/public'
import { createSupabaseServerClient } from '@supabase/auth-helpers-sveltekit'
import type { Handle } from '@sveltejs/kit'

export const handle: Handle = async ({ event, resolve }) => {
	event.locals.supabase = createSupabaseServerClient({
		supabaseUrl: PUBLIC_SUPABASE_URL,
		supabaseKey: PUBLIC_SUPABASE_ANON_KEY,
		event
	})

	event.locals.getSession = async () => {
		const {
			data: { session }
		} = await event.locals.supabase.auth.getSession()
		return session
	}

	return resolve(event, {
		filterSerializedResponseHeaders(name) {
			return name === 'content-range'
		}
	})
}

```

ã‚³ãƒ¼ãƒ‰äº¤æ›ãƒ«ãƒ¼ãƒˆ
src/routes/auth/callback/ +server.ts
ã“ã“ã§ã¯ï¼§ï¼¥ï¼´ã«å¯¾ã—ã¦å‹ã‚’æŒ‡å®šã—ãªã„ã¨ã€{ url, locals: { supabase } }ãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
å®£è¨€ã•ã‚Œã¦ã„ãªã„çš„ãªå¥´

```
import { redirect, type RequestHandler } from '@sveltejs/kit'

export const GET: RequestHandler = async ({ url, locals: { supabase } }) => {
	const code = url.searchParams.get('code')

	if (code) {
		await supabase.auth.exchangeCodeForSession(code)
	}

	console.log(code)

	throw redirect(303, '/')
}

```

èªè¨¼
src/routes/ +layout.server.ts
å‹ã‚’ LayoutServerLoad ã—ã¦ã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸ

```
import type { LayoutServerLoad } from './$types'

export const load: LayoutServerLoad = async ({ locals: { getSession } }) => {
	return {
		session: await getSession()
	}
}

```

src/routes/ +layout.ts
LayoutLoad ã‚’ã—ã¦ã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸ

```
import { PUBLIC_SUPABASE_ANON_KEY, PUBLIC_SUPABASE_URL } from '$env/static/public'
import { createSupabaseLoadClient } from '@supabase/auth-helpers-sveltekit'
import type { Database } from '../../database.types'
import type { LayoutLoad } from './$types'

export const load: LayoutLoad = async ({ fetch, data, depends }) => {
	depends('supabase:auth')

	const supabase = createSupabaseLoadClient<Database>({
		supabaseUrl: PUBLIC_SUPABASE_URL,
		supabaseKey: PUBLIC_SUPABASE_ANON_KEY,
		event: { fetch },
		serverSession: data.session
	})

	const {
		data: { session }
	} = await supabase.auth.getSession()

	return { supabase, session }
}
```

src/routes/ +layout.svelte

```
<script>
	import { invalidate } from '$app/navigation'
	import { onMount } from 'svelte'

	export let data

	let { supabase, session } = data
	$: ({ supabase, session } = data)

	onMount(() => {
		const {
			data: { subscription }
		} = supabase.auth.onAuthStateChange((event, _session) => {
			if (_session?.expires_at !== session?.expires_at) {
				invalidate('supabase:auth')
			}
		})

		return () => subscription.unsubscribe()
	})
</script>

<slot />
```

## å®Ÿéš›ã«èªè¨¼ã‚’å®Ÿè£…ã—ã€è¡¨ç¤ºã‚’å¤‰ãˆã‚‹

src\routes\login\+page.svelte

```
<script lang="ts">
	export let data

	let { supabase, session } = data
	$: ({ supabase, session } = data)

	async function signInWithEmail() {
		const { data, error } = await supabase.auth.signInWithPassword({
			email: 'test@example.com',
			password: '1111'
		})

		console.log(data, error)
	}

	async function logOut() {
		const { error } = await supabase.auth.signOut()
	}
</script>

<button on:click={signInWithEmail}>login</button>
<button on:click={logOut}>logout</button>

{#if session}
	<p>ãƒ­ã‚°ã‚¤ãƒ³</p>
{:else}
	<p>æœªãƒ­ã‚°ã‚¤ãƒ³</p>
{/if}

```
