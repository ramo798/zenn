---
title: "cloudflare D1ã‚’ä½¿ã†React Router v7ã®ã‚¢ãƒ—ãƒªã‚’ä½œã‚Šæ–¹ï¼ˆãŸã¶ã‚“æœ€é€Ÿï¼‰"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["cloudflare", "react", "typescript"]
published: true
---

## æ¦‚è¦

Â react router v7ã¨ã€cloudflare D1ã‚’ä½¿ç”¨ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ORMï¼ˆDrizzleï¼‰ä»˜ãã§ä½œæˆã™ã‚‹æ–¹æ³•ã‚’å‚™å¿˜éŒ²ãŒã¦ã‚‰ã¾ã¨ã‚ã¾ã™ã€‚
å°‘ã—å‰ã«æ¯”ã¹ã¦ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‘¨ã‚Šç­‰åˆ©ä¾¿æ€§ãŒå‘ä¸Šã—ã¦ã„ã¦ã¨ã¦ã‚‚ä¾¿åˆ©ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚Â 

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã‹ã‚‰ã€ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€DBã®æ¥ç¶šã¾ã§ã‚’è¡Œã„ã¾ã™ã€‚

## react router v7ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```

```bash
$npx create-react-router@latest --template remix-run/react-router-templates/cloudflare-d1
```

`remix-run/react-router-templates/cloudflare-d1` ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€

-  Drizzle ORMå°å…¥æ¸ˆã¿
- ã‚µãƒ³ãƒ—ãƒ«ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©æ¸ˆã¿
- INSERTã®å®Ÿè£…ã‚µãƒ³ãƒ—ãƒ«ä»˜ã
- é–‹ç™ºç’°å¢ƒã®èµ·å‹•ã€æœ¬ç•ªã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç­‰ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆæ¸ˆã¿

ã®çŠ¶æ…‹ã§ã€é–‹ç™ºã‚’å§‹ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚


## claudflare D1ã®ä½œæˆã¨ã€æ¥ç¶šã®ãŸã‚ã®è¨­å®š

### D1ã®ä½œæˆ

```shell
$npx wrangler d1 create d1-app-test-db
```

å®Ÿè¡Œã™ã‚‹ã¨ã€D1ã®ä½œæˆãŒå¯èƒ½ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«bindingã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã“ã‚Œã‚’`wrangler.jsonc`ã¸è¿½è¨˜ã—ã¾ã™ã€‚

```
user@pc d1-app-test % npx wrangler d1 create d1-app-test-db

 â›…ï¸ wrangler 4.18.0
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… Successfully created DB 'd1-app-test-db' in region APAC
Created your new D1 database.

{
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "d1-app-test-db",
      "database_id": "***************"
    }
  ]
}
```

### .envã®ä½œæˆ

æ¬¡ã«`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã‚’ä»¥ä¸‹ã®å†…å®¹ã§è¡Œã„ã¾ã™ã€‚

```
CLOUDFLARE_D1_ID="******"
CLOUDFLARE_ACCOUNT_ID="="******"
CLOUDFLARE_TOKEN="="******"
```

ãã‚Œãã‚Œã®å€¤ã¯ã€

`CLOUDFLARE_D1_ID`ã¯ã€ä¸Šè¨˜ã®æ“ä½œã§ä½œæˆã—ãŸæœ¬ç•ªDBã®idã‚’å…¥åŠ›ã—ã¾ã™ã€‚
`CLOUDFLARE_ACCOUNT_ID`ã¯ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®workersä¸€è¦§ã‚’ç¢ºèªã§ãã‚‹ãƒšãƒ¼ã‚¸ã®å³ä¸‹ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã¡ã‚‰ã‚’ã‚³ãƒ”ãƒšã—ã¾ã™ã€‚
`CLOUDFLARE_TOKEN`ã¯ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šã®å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®manage account -> Account api tokenã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®ç”»åƒã®ã‚ˆã†ã«ä½œæˆã—ã¾ã™ã€‚

![](/images/2a0c5e997da019/image3.png)


### drizzle.config.tsã®ä¿®æ­£

`drizzle.config.ts`ã®databaseIdã ã‘ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãŸã®ã§ã€ã“ã¡ã‚‰ã‚‚ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã‚€ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãŠãã¾ã™ã€‚

```ts
import type { Config } from "drizzle-kit"

export default {
  out: "./drizzle",
  schema: "./database/schema.ts",
  dialect: "sqlite",
  driver: "d1-http",
  dbCredentials: {
    databaseId: process.env.CLOUDFLARE_D1_ID!,
    accountId: process.env.CLOUDFLARE_ACCOUNT_ID!,
    token: process.env.CLOUDFLARE_TOKEN!,
  },
} satisfies Config

```

## DBã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã€workersã®ãƒ‡ãƒ—ãƒ­ã‚¤

### DBã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

æœ¬ç•ªã®DBã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã„ã¾ã™ã€‚

```shell
$npm run db:migrate-production
```

### workersã®ãƒ‡ãƒ—ãƒ­ã‚¤

```shell
$npm run deploy
```

ã“ã¡ã‚‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ¥ç¶šç”¨ã®URLãŒå‡ºã‚‹ã®ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
ã€œã€œã€œã€œã€œã€œã€œ çœç•¥ ã€œã€œã€œã€œã€œã€œã€œ


Uploaded react-router-app (7.70 sec)
Deployed react-router-app triggers (0.61 sec)
  https://react-router-app.**********.workers.dev
Current Version ID: d63b787b-51ef-45df-a7f7-**************
```

é©å½“ãªå€¤ã‚’å…¥åŠ›ã—ã¦ã€ã‚¢ãƒ—ãƒªä¸Šã¨ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®æŒ¿å…¥ã‚’ç¢ºèªã—ã¾ã™ã€‚

![](/images/2a0c5e997da019/image1.png)
![](/images/2a0c5e997da019/image2.png)


è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚
ã‚„ã£ãŸã­ï¼

## é–‹ç™ºç’°å¢ƒã®èµ·å‹•

```shell
$ npm run db:migrate
$ npm run dev
```

ã“ã¡ã‚‰ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®DBã«æ¥ç¶šã—ãŸçŠ¶æ…‹ã§ã€é–‹ç™ºã‚’è¡Œãˆã¾ã™ã€‚

## ã¾ã¨ã‚

ã“ã‚Œã§å®‰ã„ã€æ—©ã„ã€ã†ã¾ã„ãŒæƒã£ãŸç’°å¢ƒãŒç°¡å˜ã«æ‰‹ã«å…¥ã‚Šã¾ã™ã€‚
ã‚¬ãƒ³ã‚¬ãƒ³ã‚¢ãƒ—ãƒªä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ï¼ï¼ï¼