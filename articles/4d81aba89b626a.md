---
title: "prisma + PostgreSQL + pgvectorã§é¡”ã®é¡ä¼¼æ¤œç´¢ã‚’ã—ã¦ã¿ã‚‹"
emoji: "ğŸ‘©"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

## åˆã‚ã«

PostgreSQL ã®æ‹¡å¼µãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã‚ã‚‹ pgvector ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ™ã‚¯ãƒˆãƒ«ç®¡ç†ãƒ»æ¤œç´¢ãŒè¡Œãˆã¾ã™ã€‚
https://github.com/pgvector/pgvector

ä»Šå›ã¯ pgvector ã‚’ç”¨ã„ã¦ä¼¼ã¦ã„ã‚‹é¡”ã‚’æ¤œç´¢ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã—ã¾ã™ã€‚
typesprict ã§ä½œæˆã—ãŸ web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«çµ„ã¿è¾¼ã‚€ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã‚‹ã®ã§ prisma ã‚’ç”¨ã„ã¾ã™ã€‚

ã§ã¯ã‚„ã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ â†’ prisma client ã®ä½œæˆ

### PostgreSQL ã¨ pgvector ã®ç”¨æ„

pgvector ã®æ‹¡å¼µãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ãŒé¢å€’ã§ã—ãŸã®ã§ã€
DockerHub ã§æ¢ã™ã¨ `ankane/pgvector:v0.4.4` ã¨ã„ã† image ãŒã‚ã£ãŸã®ã§ã“ã‚Œã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚
:::message alert
image ã®ä¸­èº«ã®æ¤œè¨¼ã‚’ã—ã¦ã„ãªã„ã®ã§ã€ã“ã® image ã®ä½¿ç”¨ã¯è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚
:::

### prsima ã§ migrate

ã¾ãšã¯ prisma ã§ init ã—ã€schema ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚
æ›¸ãæ–¹ã¯ä»¥ä¸‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚
https://github.com/pgvector/pgvector-node#prisma

```:schema.prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector", schema: "public")]
}

model FaceEmbedding {
  id        Int                   @id @default(autoincrement())
  personId  Int
  embedding Unsupported("vector")
}
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚

```
npx prisma migrate dev
prisma generate
```

## ç”»åƒã‹ã‚‰é¡”ã®ç‰¹å¾´é‡ã‚’å–ã‚Šå‡ºã—ã€DB ã¸ä¿å­˜ã™ã‚‹

### ç”»åƒã®ç”¨æ„

æ°´ç€¬ã„ã®ã‚Šã€ä½å€‰ç¶¾éŸ³ã€å¤§è¥¿æ²™ç¹”ã®ç”»åƒã‚’ 5 æšã¥ã¤ç”¨æ„ã—ã¾ã—ãŸã€‚

![inorin](/images/4d81aba89b626a/inorin.png)
![ayaneru](/images/4d81aba89b626a/ayaneru.png)

### å„ç”»åƒã‹ã‚‰é¡”ã®ç‰¹å¾´é‡ã®æŠ½å‡º

ä»Šå›ã¯é¡”ã®ç‰¹å¾´é‡ã®ä½œæˆã« `facenet-pytorch` ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚
https://github.com/timesler/facenet-pytorch

ã“ã‚Œã‚’ç”¨ã„ã‚‹ã¨é¡”ã‹ã‚‰ 512 æ¬¡å…ƒã®ãƒ™ã‚¯ãƒˆãƒ«ã§ç‰¹å¾´é‡ã‚’æŠ½å‡ºã—ã¦ãã‚Œã¾ã™ã€‚
å„ç”»åƒã«å¯¾ã—ã¦ç‰¹å¾´é‡ã®æŠ½å‡ºã‚’è¡Œã„ã¾ã™ã€‚

```python:
img = Image.open(os.path.join(img_dir, filename))
face = mtcnn(img)
emb = resnet(face.unsqueeze(0)).detach().numpy()
```

### db ã«ãƒ™ã‚¯ãƒˆãƒ«ã‚’ insert ã™ã‚‹

python ã§ pgvector ã‚’æ‰±ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚Šã¾ã—ãŸã€‚
https://github.com/pgvector/pgvector-python

ã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ã€ä½œæˆã—ãŸãƒ™ã‚¯ãƒˆãƒ«ã‚’ DB ã«ä¿å­˜ã—ã¾ã™ã€‚
ä»¥ä¸‹ã¯ psycopg2 ã‚’ä½¿ç”¨ã—ãŸå ´åˆã®ä¾‹ã§ã™ã€‚

```python:
import psycopg2
from pgvector.psycopg2 import register_vector

conn = psycopg2.connect(host=host, dbname=dbname, user=user, password=password)
register_vector(conn)
cur = conn.cursor()
cur.execute('INSERT INTO "FaceEmbedding" ("personId", embedding) VALUES (3, %s)', (emb,))
conn.commit()
```

æŒ¿å…¥ã§ãã¾ã—ãŸã€‚

![db](/images/4d81aba89b626a/db.png)

## é¡”é¡ä¼¼æ¤œç´¢ã‚’è¡Œã†

### prisma ã§ã‚¯ã‚¨ãƒªã‚’ãŸãŸãé››å½¢ã‚’ä½œæˆ

```ts:main.ts
import { PrismaClient } from "@prisma/client"

const prisma = new PrismaClient()

async function main() {
  const list = await prisma.$queryRaw`
    SELECT
      id, "personId"
    FROM
      "FaceEmbedding"
  `
  console.log(list)
}

main()
```

```:å‡ºåŠ›
[
  { id: 1, personId: 1 },
  { id: 2, personId: 1 },
  { id: 3, personId: 1 },
  { id: 4, personId: 1 },
  { id: 5, personId: 1 },
  { id: 6, personId: 2 },
  { id: 7, personId: 2 },
  { id: 8, personId: 2 },
  { id: 9, personId: 2 },
  { id: 10, personId: 2 },
  { id: 11, personId: 3 },
  { id: 12, personId: 3 },
  { id: 13, personId: 3 },
  { id: 14, personId: 3 },
  { id: 15, personId: 3 }
]
```

### å®Ÿéš›ã«é¡ä¼¼æ¤œç´¢ã‚’è¡Œã†

ã§ã¯ã€å®Ÿéš›ã«ãƒ™ã‚¯ãƒˆãƒ«ã‚’ä½¿ã£ã¦ã‚¯ã‚¨ãƒªã‚’ãŸãŸãã¾ã™ã€‚
id:1 ã®æ°´ç€¬ã„ã®ã‚Šã®é¡”ã®ç‰¹å¾´é‡ã‚’ç”¨ã„ã¦ã€cos è·é›¢ã‚’ä½¿ç”¨ã—ã¦è·é›¢ãŒè¿‘ã„é †ã«ä¸Šã‹ã‚‰ 5 å€‹å–å¾—ã—ã¾ã™ã€‚
ã¤ã„ã§ã« cos é¡ä¼¼åº¦ã‚‚è¡¨ç¤ºã—ã¾ã™ã€‚
æ°´ç€¬ã„ã®ã‚Šã®ç”»åƒã¯ 5 æšç™»éŒ²ã—ã¦ã„ã‚‹ã®ã§ã€ LIMIT 5 ã§ usetId ãŒå…¨éƒ¨ 1 ãªã‚‰ã¡ã‚ƒã‚“ã¨ä¼¼ã¦ã„ã‚‹é¡”ã‚’æ¤œç´¢ã§ãã¦ã„ã‚‹ã¨è¨€ãˆãã†ã§ã™ã€‚

:::message
cos é¡ä¼¼åº¦ã¯ 1 ã‹ã‚‰-1 ã®å€¤ã‚’ã¨ã‚Šã€1 ã«è¿‘ã„ã»ã©ãƒ™ã‚¯ãƒˆãƒ«ä¼¼ã¦ãŠã‚Šã€-1 ã«è¿‘ã„ã»ã©ä¼¼ã¦ã„ãªã„ã¨ãªã‚Šã¾ã™ã€‚
:::

ã‚¯ã‚¨ãƒªã¯ã“ã†ã§ã™ã€‚

```sql:
SELECT
  id, "personId", 1 - (embedding <=> (SELECT embedding FROM "FaceEmbedding" WHERE id = 1)) AS cosine_similarity
FROM
  "FaceEmbedding"
ORDER BY
  embedding <=> (SELECT embedding FROM "FaceEmbedding" WHERE id = 1)
LIMIT 5
```

çµæœã¯ã“ã†ã§ã™ã€‚

```
[
  { id: 1, personId: 1, cosine_similarity: 1 },
  { id: 5, personId: 1, cosine_similarity: 0.9087675117139582 },
  { id: 4, personId: 1, cosine_similarity: 0.8679171024203919 },
  { id: 2, personId: 1, cosine_similarity: 0.8474558816347088 },
  { id: 3, personId: 1, cosine_similarity: 0.7921975676309791 }
]
```

ã¡ã‚ƒã‚“ã¨å–å¾—ã§ãã¦ã„ãã†ã§ã™ã€‚

id:11 ã®ç‰¹å¾´é‡ã‚’ä½¿ç”¨ã—ãŸå ´åˆã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
personId ã¯ 3 ãªã®ã§å¤§è¥¿æ²™ç¹”ã§ã™ã­

```
SELECT
  id, "personId", 1 - (embedding <=> (SELECT embedding FROM "FaceEmbedding" WHERE id = 12)) AS cosine_similarity
FROM
  "FaceEmbedding"
ORDER BY
  embedding <=> (SELECT embedding FROM "FaceEmbedding" WHERE id = 12)
LIMIT 5
```

```
[
  { id: 12, personId: 3, cosine_similarity: 1 },
  { id: 14, personId: 3, cosine_similarity: 0.8723990442868933 },
  { id: 11, personId: 3, cosine_similarity: 0.8329527631679011 },
  { id: 13, personId: 3, cosine_similarity: 0.7559596640701564 },
  { id: 15, personId: 3, cosine_similarity: 0.7152676916689075 }
]
```

ã¡ã‚ƒã‚“ã¨ä¼¼ãŸé¡”ã‚’æŠ½å‡ºã§ãã¦ã„ãã†ã§ã™ã€‚

ã¡ãªã¿ã« LIMIT ã‚’å¤–ã—ã¦ã™ã¹ã¦ã‚¹ã‚³ã‚¢ã‚’å‡ºã—ã¦ã¿ã¾ã™ã€‚

```
[
  { id: 1, personId: 1, cosine_similarity: 1 },
  { id: 5, personId: 1, cosine_similarity: 0.9087675117139582 },
  { id: 4, personId: 1, cosine_similarity: 0.8679171024203919 },
  { id: 2, personId: 1, cosine_similarity: 0.8474558816347088 },
  { id: 3, personId: 1, cosine_similarity: 0.7921975676309791 },
  { id: 12, personId: 3, cosine_similarity: 0.4142360076233724 },
  { id: 15, personId: 3, cosine_similarity: 0.41278395343945573 },
  { id: 11, personId: 3, cosine_similarity: 0.35532161824856123 },
  { id: 14, personId: 3, cosine_similarity: 0.30938845868067055 },
  { id: 13, personId: 3, cosine_similarity: 0.23102589274443774 },
  { id: 9, personId: 2, cosine_similarity: 0.22384490461591244 },
  { id: 10, personId: 2, cosine_similarity: 0.1999829384866848 },
  { id: 7, personId: 2, cosine_similarity: 0.1632603921874849 },
  { id: 6, personId: 2, cosine_similarity: 0.12457679634476515 },
  { id: 8, personId: 2, cosine_similarity: 0.10706567962724378 }
]
```

æ°´ç€¬ã„ã®ã‚Šã¯ã€ä½å€‰ç¶¾éŸ³ã¨å¤§è¥¿æ²™ç¹”ãªã‚‰ã©ã¡ã‚‰ã‹ã¨ã„ã†ã¨ã€å¤§è¥¿æ²™ç¹”ã«ä¼¼ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
