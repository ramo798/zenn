---
title: "hono rpc で sveltekit + cloudflare kvの開発体験がすごく良くなった話"
emoji: "😺"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

## 始めに

Cloudflare Meet-up や、Workers Tech Talks が開催されたり、Birthday Week での発表で Cloudflare 界隈は盛り上がっていますね。

私も、hono をバックエンドの API として使用し、sveltekit をフロントエンドとして開発を行っていました。
hono は cloud run 似て動かし、sveltekit を cloudflare pages 上で動かして、バックエンド API のレスポンスをキャッシュとして workers kv に格納するという構成です。
それぞれ別のリポジトリとして開発を行っていましたが、それをモノレポに移した際、hono の prc を試したら、上記構成の開発において、すごく開発体験が向上したので、その話をします。

## hono prc モードとは

後でかく

## どういうことが良くなったのか

###　 feach をする時に使用するレスポンスに型をつけるための interface の宣言からの解放

これまでの開発として、 API の作成を行い、そのデータを受け取るための型を sveltekit で作成し、feach していた。
これが、
API を作成 →sveltekit 上で呼び出す。
これだけになった。

これによってレスポンスの定義が変わるたびに interface を書き換えるという手間が無くなったのでとても良くなった。

API からのデータを kv に保存する際、json の文字列として保存していた。
その、データを取り出す際に、json.parse を行い、オブジェクトに変換していた。
hono rpc を使用することで、オブジェクトへの型付けが容易になった。

なぜなら RPC で呼び出すエンドポイントの型を取得できるからである。
以下のように`InferResponseType`を使うことで型を取得できる
もちろん、hono 側のコードを変更すると、型の中身も動的に変化する。

```
type ResponseType = InferResponseType<typeof client.hello.$get>;
// vscodeで型を確認すると以下のように確認できる
type ResponseType = {
    message: string;
}
```

### DB スキーマの変更時の作業からの解放

バックエンドで prisma を使用しており、フロントの型付けのためにスキーマファイルをコピーしてきて型のみを使用する形をとっていたが、スキーマ変更した際に更新を忘れ動かないストレスからの解放があった
`prisma generate`忘れがち

## 実例

### hono にて rpc を利用するためのコード

基本的には、`c.json()` としていた部分を、`c.jsonT()` とするだけです。

```ts
import { Hono } from "hono"

const apiApp = new Hono()

const apiRoute = apiApp.get("/hello", (c) => {
  return c.jsonT({
    message: `Hello!`,
  })
})

export default apiApp
export type ApiRoute = typeof apiRoute
```

### クライアントからエンドポイントを呼び出すためのコード

下記だけです、client として、hono client を宣言するだけで、あとは予測変換だけで呼び出すエンドポイントを選択できます。
注意点としては、別のアプリケーションとして稼働している API サーバの場合、URL を引数で渡す必要があります。

```ts
import type { ApiRoute } from "上記のhonoでexportしたApirouteの場所"
const client = hc<ApiRoute>("http://localhost:3000/")
const res = await client.hello.$get()
const data = await res.json()
```

### 最終的な sveltekit のコード

kv 上にデータがない場合、エンドポイントへリクエストするイメージです。
kv 上には JSON の文字列が入っているので、パースしてから型をつけますが、それも楽にできています。

```ts
import { hc } from "hono/client"
import type { PageServerLoad } from "./$types"
import type { ApiRoute } from "../../../hono/src/index"
import type { InferResponseType } from "hono/client"

export const load: PageServerLoad = async ({ platform }) => {
  const cache = await platform?.env?.MY_KV.get("path")
  if (cache) {
    return {
      tmp: JSON.parse(cache) as InferResponseType<typeof client.hello.$get>,
    }
  }

  const client = hc<ApiRoute>("http://localhost:3000/")
  const res = await client.hello.$get()
  const data = await res.json()
  await platform?.env?.MY_KV.put("path", JSON.stringify(data))

  return {
    tmp: data,
  }
}
```

## まとめ

開発体験が良くなりました。
理想としては D1 に完全移行できれば別に API サーバを用意する必要もないのですが、prisma を剥がす作業と、DB をベクターストアとして使っている都合上移行がめんどくさいですね、、
Cloudflare Vectorize がローカルで使えるようになれば本格的に移行を検討していきたいところです。
